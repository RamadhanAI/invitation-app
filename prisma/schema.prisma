// prisma/schema.prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ----------------------------------------------------------
// ORGANIZER + STAFF
// ----------------------------------------------------------

model Organizer {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  apiKey    String   @unique
  brand     Json?
  createdAt DateTime @default(now())

  // "pending" | "active" | "suspended"
  status    String   @default("pending")

  events     Event[]
  users      OrganizerUser[]
  templates  EventTemplate[] // ✅ relation
}

model OrganizerUser {
  id          String   @id @default(uuid())
  organizerId String
  email       String
  name        String?
  role        String   @default("admin") // "admin" | "editor" | "scanner"

  passwordHash String?

  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?

  inviteTokenHash String?
  inviteExpiresAt DateTime?

  createdAt DateTime @default(now())

  organizer Organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)

  @@unique([organizerId, email])
  @@index([organizerId])
  @@index([email])
  @@index([inviteExpiresAt])
}

// ----------------------------------------------------------
// EVENT TEMPLATE (for presets)
// ----------------------------------------------------------

model EventTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  defaults    Json
  createdAt   DateTime @default(now())

  organizerId String?
  organizer   Organizer? @relation(fields: [organizerId], references: [id], onDelete: SetNull)

  // ✅ Unique per organizer (NULL organizerId is allowed for legacy rows)
  @@unique([organizerId, name], name: "eventtemplate_org_name")
  @@index([organizerId, createdAt])
}

// ----------------------------------------------------------
// EVENT + STATION + ATTENDANCE LOG
// ----------------------------------------------------------

model Event {
  id          String   @id @default(uuid())
  slug        String   @unique
  title       String
  date        DateTime
  price       Int
  description String?
  venue       String?
  capacity    Int?
  currency    String   @default("USD")
  status      String   @default("published")
  createdAt   DateTime @default(now())

  organizerId String?
  organizer   Organizer? @relation(fields: [organizerId], references: [id], onDelete: SetNull)

  registrations    Registration[]
  payments         Payment[]
  stations         Station[]
  attendanceEvents AttendanceEvent[]

  @@index([organizerId])
}

model Station {
  id         String  @id @default(uuid())
  eventId    String
  name       String
  code       String
  secretHash String
  active     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, code], name: "station_event_code")
  @@index([eventId])
}

model Registration {
  id String @id @default(uuid())

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  email String
  price Int
  paid  Boolean @default(false)

  qrToken      String   @unique
  registeredAt DateTime @default(now())

  attended     Boolean   @default(false)
  scannedAt    DateTime?
  scannedBy    String?
  checkedOutAt DateTime?
  checkedOutBy String?

  meta Json?

  attendanceEvents AttendanceEvent[]

  @@unique([eventId, email], name: "eventId_email")
  @@unique([eventId, qrToken], name: "eventId_qrToken")
  @@index([eventId])
  @@index([eventId, registeredAt])
  @@index([eventId, attended])
  @@index([eventId, scannedBy])
  @@index([eventId, checkedOutBy])
}

model AttendanceEvent {
  id String @id @default(cuid())

  eventId        String
  registrationId String
  qrToken        String

  action        String
  stationLabel  String?
  scannedByUser String?
  at            DateTime @default(now())

  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  event        Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, at])
  @@index([qrToken, at])
  @@index([registrationId, at])
}

model Payment {
  id        String  @id @default(uuid())
  eventId   String
  email     String
  amount    Int
  currency  String  @default("USD")
  provider  String  @default("stripe")
  status    String  @default("pending")
  sessionId String? @unique
  chargeId  String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, status])
}

// ----------------------------------------------------------
// REQUEST DEMO / ACCESS PIPELINE (PUBLIC FORM)
// ----------------------------------------------------------

model DemoRequest {
  id           String   @id @default(uuid())
  name         String
  email        String
  company      String
  role         String?
  phone        String?
  timezone     String?
  availability Json?
  notes        String?

  status       String   @default("new")
  createdAt    DateTime @default(now())

  @@index([email])
  @@index([status, createdAt])
}
